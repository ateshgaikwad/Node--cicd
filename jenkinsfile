pipeline {

    agent none

    stages {

        stage('Build Inside Docker') {
            agent {
                docker {
                    image 'node:18-alpine'
                }
            }
            environment {
                NPM_CONFIG_CACHE = "${WORKSPACE}/.npm"
            }
            steps {
                checkout scm
                sh 'npm install'
                sh 'npm test'
            }
        }

        stage('Deploy on Jenkins EC2') {
            agent any
            steps {
                sh '''
                    echo "Deploying to App EC2..."

                    # Send files to app server
                    rsync -avz --exclude=node_modules/ ./ ubuntu@13.232.194.226:/var/www/nodeapp

                    # Install dependencies + restart app
                    ssh -o StrictHostKeyChecking=no ubuntu@13.232.194.226 "
                        cd /var/www/nodeapp &&
                        npm install &&
                        pm2 restart all || pm2 start server.js
                    "
                '''
            }
        }

        stage('Done') {
            agent any
            steps {
                echo "Deployment completed successfully!"
            }
        }
    }
}

